# CURSOR EXECUTION RULES - NLU Finalization & CI Update

**Objective:** Execute the provided **3-Phase Plan** (focused on verifying/fixing `train.py` output and updating CI workflow) precisely. The goal is to ensure the simplified NLU system is fully functional and the repository reflects this state.

**Your Primary Directive:** Follow the 3-Phase plan with absolute accuracy. Your scope is limited to verifying `train.py` execution, ensuring `./trained_nlu_model/` is correctly generated, cleaning `inference.py`, running specific verification tests, and updating the CI workflow file.

---

## I. General Principles

1.  **Strict Plan Adherence:** You MUST follow the **3-Phase Plan** provided _most recently_. Do not refer back to older, longer plans (like `plan3fixshit.md`). Execute phases and steps sequentially and exactly as written.
2.  **Targeted Modifications ONLY:**
    - In Phase 1, you are ONLY permitted to modify `train.py` IF NEEDED to correct the specific issues identified (e.g., `eval_strategy`, error handling in entity prep, unseen label handling).
    - In Phase 2, you are ONLY permitted to modify `.github/workflows/ci.yml` as instructed.
    - You are **NOT PERMITTED** to modify `inference.py`, `dialog_manager.py`, `response_generator.py`, or any other core logic file in this plan.
3.  **No Unsolicited Code:** DO NOT add any new features, functions, classes, complex error handling (beyond the specific `try...except` instructed for `train.py`), optimizations, or logic.
4.  **CPU Execution ONLY:** Ensure `train.py` runs using the CPU (`no_cuda=True` should be set in `TrainingArguments`). All tests run on CPU.
5.  **Preserve Specific Files:** You MUST NOT delete `cleanup.py`, `plan3fixshit.md`, or `imp-rules.md` during any step.

## II. Phased Execution and Verification

6.  **Complete Phases Sequentially:** Finish ALL steps within the current phase, including passing the specified test, before starting the next phase.
7.  **Mandatory Verification:** Each phase includes explicit verification steps (checking file existence, running commands) and a final test script. You MUST perform _all_ verification steps and confirm their success before running the phase's final test script.
8.  **Test Integrity - CRITICAL:** **DO NOT MODIFY THE TEST SCRIPTS (`test_phase*.py`, `test_integration.py`) UNDER ANY CIRCUMSTANCES.** If a test fails, the issue is in the code you were instructed to modify/run in that phase, OR the prerequisite state wasn't met.
9.  **Debugging Failing Tests (Limited Scope):**
    - If `test_phase2.py` fails (after Phase 1): The issue is likely in `train.py` or its execution. Review the `train.py` fixes (Step 1.3), clean the output directory (Step 1.2), and rerun training (Step 1.4). Verify artifacts (Step 1.5) before re-testing.
    - If `test_phase3.py` fails (after Phase 2): This test should _not_ fail if Phase 1 and the previous plan's Phase 3 completed correctly, as `inference.py` is _not_ modified in this new plan. If it fails, STOP and report the error, indicating a potential issue in `inference.py` that was missed earlier.
    - If `test_integration.py` fails (in Phase 3): Ensure you removed mocking code. The failure likely points to issues in the _models_ generated by `train.py` or how `NLUInferencer` loads/uses them. Debugging should focus _only_ on potential loading/runtime errors within `NLUInferencer`, NOT its core logic (which was assumed correct from previous plans). If model performance seems the issue, STOP and report, do not attempt extensive retraining.
    - If `test_phase5.py` fails (in Phase 3): The issue is likely with the CI workflow file edits or potentially `cleanup.py` (if run) deleting something it shouldn't have. Review the CI file changes and the file structure.
    - If you cannot resolve a test failure by fixing ONLY the code explicitly mentioned for modification _within that phase_, STOP and report (Rule 11).
10. **Verify File/Directory Creation:** Explicitly run the verification commands in Phase 1, Step 5 to confirm model artifact creation _before_ running `test_phase2.py`.

## III. File and Path Handling

11. **Use Correct Paths:** All file paths are relative to the project's root directory. Use paths precisely.
12. **No Deletions (Except Trained Models):** Other than removing `./trained_nlu_model/` at the start of Phase 1 (Step 1.2), DO NOT delete any other files or directories unless explicitly instructed by a future plan _after_ this one completes. The `cleanup.py` script should NOT be run as part of this plan.

## IV. Reporting and Error Handling

13. **Confirm Phase Completion:** After successfully completing all steps in a phase AND passing its associated test(s), explicitly state: "Phase [X] completed successfully. All verification steps passed and Test(s) [test_script_name(s).py] passed."
14. **STOP on Error:** If any command fails, if a verification step fails, if a test fails and you cannot resolve it per Rule 9, or if instructions are unclear, STOP EXECUTION IMMEDIATELY.
15. **Report Errors Clearly:** When stopping due to an error (Rule 14), report:
    - The Phase number and Step number.
    - The exact command run or verification attempted.
    - The FULL error message or test failure output.
    - Confirm that you did NOT modify any files other than those specified for that phase.

---

**Acknowledge these updated rules before starting Phase 1 of the new 3-Phase plan.** Your focus is narrow: fix training output, update CI, verify.
